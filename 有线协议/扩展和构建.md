# 修改协议

[TOC]

由于协议是使用Protocol Buffers格式指定和生成的，因此很容易修改和扩展。通过添加新的可选字段可以轻松引入新的消息类型，而不会破坏与客户端，服务器或VM的未修改版本的兼容性。运行较旧协议版本的组件无法识别的可选字段将被忽略，就好像它们从未存在过一样。

为了获得最佳结果，请避免更改任何现有字段，尤其是必需字段，因为这可能会导致破坏现有已部署的组件。

首先查看svmp-protocol-def项目

```
git clone https://github.com/SVMP/svmp-protocol-def
```

您还需要安装[Protocol Buffers v2.5.0](https://code.google.com/p/protobuf/)工具，特别是protoc编译器。版本2.6尚未经过兼容性测试。

## SVMP服务器

所述SVMP服务器利用了在解释所以没有码生成在这种情况下所需要的运行时间的协议规范文件中的JavaScript库。只需将更新后的`svmp.proto`文件复制到`svmp-server/protocol/`目录中，即可覆盖已存在的副本。然后重启服务器进程。

## Android客户端

虚拟设备映像中包含的Android客户端应用程序和SVMP守护程序都使用从协议缓冲区规范文件生成的Java代码库。此Java代码包含在svmp-protocol-def中，必须重新生成以使任何协议更改生效。

要在Android客户端的svmp-protocol-def包中重新生成Java代码：

```
cd svmp-android-client / svmp-protocol-def
protoc --java_out = src / svmp.proto
```

然后正常重建客户端。

## 虚拟机映像

与Android客户端一样，虚拟设备映像使用从协议定义文件生成的Java代码库。

要在VM代码树中重新生成它：

```
cd external / svmp / svmp-protocol-def
protoc --java_out = src / svmp.proto
```

正常运行VM构建脚本。

## iOS客户端

iOS客户端需要从协议定义文件生成Objective-C代码。

从协议定义文件生成Objective-C代码需要一个额外的[插件](https://github.com/Packetdancer/protobuf-objc)。使用以下命令下载，构建和安装插件：

```
git clone https://github.com/Packetdancer/protobuf-objc.git
cd protobuf-objc
./autogen.sh
./configure CXXFLAGS = -I / usr / local / include LDFLAGS = -L / usr / local / lib
使
make install
```

接下来使用protoc和插件生成Obj-C代码：

```
cd svmp-iOS-client
protoc --plugin = / usr / local / bin / protoc-gen-objc \
       --proto_path = .. / svmp-protocol-def / \
       --objc_out =。/ ios-example / AppRTCDemo ../svmp-protocol-def/svmp.proto
```

执行此命令后，目录中应该有一个`Svmp.pb.h`和`Svmp.pb.m`文件`svmp-iOS-client/ios-example/AppRTCDemo`。

不幸的是，插件生成的目标c代码存在错误。您必须在Svmp.pb.m文件中的storeInDictionary方法中注释掉for循环。

```
  - (void) storeInDictionary:(NSMutableDictionary *)dictionary {

    ...

    // V-- Comment this out otherwise you will get an error stating 'use of undeclared identifier 'output''
    //for (NSString* element in self.categoriesArray) {
    //  [output appendFormat:@"%@%@: %@\n", indent, @"categories", element];
    //}
    [self.unknownFields storeInDictionary:dictionary];
  }
```