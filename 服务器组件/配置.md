# 配置SVMP服务器组件

[TOC]

SVMP服务器和监督器通过各自的`config/config-local.yaml`文件和[命令行配置工具进行配置](https://svmp.github.io/server-install.html#configuration-tool)。

每个服务器组件包括示例配置文件。复制此文件以开始使用

```
$ cp config/_config.local.template.yaml config/config-local.yaml
```

每个模板中的注释都广泛记录了可用的配置选项。您应首先配置监督（设置证书和身份验证令牌），然后配置服务器和配置工具。

下面解释了几个更重要的任务。

## 记录

SVMP服务器可以输出用户会话和连接尝试的详细日志。日志文件和详细信息由两个变量控制：

1. `log_file`：输出日志文件的完整路径。日志消息以机器可读的JSON格式写入，并带有附加的时间戳值。相应的人类可读消息被打印到stdout。

2. `log_level`：日志输出的详细程度。对于生产部署，“info”是建议的输出级别。较高级别（“verbose”, “debug”,和 “silly”）可能对调试配置和运行时错误很有用。

   **警告**：最高级别（“silly” and “debug”）会将可能敏感的数据输出到日志文件，包括会话令牌。只有当您知道自己在做什么，并且**从不**投入生产时，才使用这些级别。

## SSL / TLS

要在监督与客户端之间使用TLS加密，请在监督配置文件中设置以下字段以启用TLS并提供密钥和证书文件的完整路径。

```
enable_ssl: true,
server_certificate: '/path/to/overseer-cert.pem',
private_key: '/path/to/overseer-key.pem',
private_key_pass: 'password for the private key',
```

如果监督者使用TLS加密，则服务器也必须这样做。在服务器的配置文件中设置以下字段：

```
enable_ssl: true,
server_certificate: '/path/to/server-cert.pem',
private_key: '/path/to/server-key.pem',
private_key_pass: 'password for the private key',
```

此外，`overseer_url`服务器配置文件中字段中的协议必须与TLS是否启用相对应（例如，分别为“https”或“http”）。如果任何私钥文件未受密码保护，请使用空字符串值：

```
private_key_pass: '',
```

## 配置验证

SVMP监督可以使用多种方法之一来验证用户。

### 密码

除非特别启用其他方法之一，否则服务器将默认使用密码身份验证。密码存储在服务器的MongoDB数据库中。用户模型要求密码长度至少为8个字符。

```
authentication_type: 'password'
```

### PAM

SVMP服务器可以使用底层系统的Pluggable Authentication Modules服务来执行用户身份验证。这是生产环境的首选方法。通过利用PAM，SVMP服务器可以利用已经实现为PAM模块的各种身份验证方法，包括RADIUS，LDAP，/ etc / passwd等等。

要启用PAM身份验证，请在配置文件中设置以下字段：

```
authentication_type: 'pam'
pam_service: 'service-name'
```

'service-name'与文件对应的位置`/etc/pam.d/service-name`。

配置PAM超出了本文档的范围，但在线提供了许多优秀的资源。只需要“auth”设施。

使用RADIUS的示例：

```
$ cat /etc/pam.d/svmp
auth    required    pam_radius_auth.so
```

### PKI证书

要使用基于x.509 PKI证书的身份验证：

1. 确保服务器配置为使用TLS加密。往上看。
2. 在Overseer的配置文件中，设置`authentication_type`为“certificate”。
3. 在服务器的配置文件中，设置`cert_user_auth`为“true”。
4. 在监督和服务器的配置文件中，设置`ca_cert`为用于签署客户端证书的证书颁发机构公共证书的路径。
5. 在客户端设备上安装由该CA签名的客户端证书（可在[Google支持网站](https://support.google.com/nexus/answer/2844832?hl=en)上找到Android客户端的说明）。

使用证书时的默认身份验证逻辑是匹配服务器用户数据库提供的用户证书中的用户名字段。

## 配置服务器

必须将每个svmp-server实例配置为与监督者通信。

`overseer_url`：REST调用监督的基本URL。

`overseer_cert`：包含监督者公共证书的PEM文件的路径。需要验证授予用户的身份验证令牌。

`auth_token`：监督员创建的服务器身份验证令牌。授予此svmp-server实例访问Overseer的REST API以管理VM生命周期。

要为svmp-server生成身份验证令牌，请使用`create-token`监督程序附带的脚本。

```
$ node create-token.js -a [-e expiration_time] svmp-server-N
```

此工具还用于为管理员用户创建令牌，以便与配置工具一起使用。

## 管理用户

用户管理主要通过配置工具完成。可以通过运行以下命令获取其命令的完整列表：

```
$ svmp-config -h
```

### 创建

使用以下命令创建新用户：

```
$ svmp-config add <username> <password> <email> <device_type>
```

所有字段`都是必填`字段，如果其中任何字段未验证，则会触发500错误。密码字段长度必须为8个字符; 仅当服务器配置为使用密码身份验证时才使用其内容。电子邮件字段必须是有效的电子邮件地址。设备类型字段必须与以下所示的配置类型之一匹配：

```
$ svmp-config devices
```

有关配置设备类型列表的更多详细信息，请参阅“自动化生命周期”部分中的以下内容。

### 列出用户详情

要打印当前在系统中配置的用户摘要：

```
$ svmp-config list
```

这将输出所有用户的表，当前为该用户配置的设备类型，云基础架构中其持久数据卷的ID，以及当前存在的虚拟设备实例的ID和IP地址。

### 删除

要删除用户，请运行：

```
$ svmp-config delete <username>
```

这将从SVMP服务器的数据库中删除用户帐户。它将保留其数据卷和任何实例化的虚拟设备。

## 管理虚拟设备

可以手动或通过云提供商自动管理虚拟设备。

### 手动分配

对于测试，开发和小规模部署，可以手动创建用户的虚拟设备并静态分配。

1. 创建一个新用户帐户，如上所述
2. 首先[启动虚拟设备实例](https://svmp.github.io/vm-install.html)
3. 获取VM的DHCP分配的IP地址。这将打印到引导日志输出到VM的串行端口控制台。
4. 将VM注册到用户$ svmp-config vm-add

例：

```
$ svmp-config devices
Supported device types (settings.new_vm_defaults.images):
┌─────────────┐
│ Device Type │
├─────────────┤
│ device-x    │
└─────────────┘

$ svmp-config add alice password email device-x
Adding a new User...
    Created user:  alice  Password:  password  Device:  device-x

$ svmp-config vm-add alice 10.0.0.42
Adding existing VM for  alice
Success: Assigned IP to an existing VM

$ svmp-config list
Proxy users:
┌───────┬───────────┬───────┬────────┬──────────┐
│ User  │ VM_IP     │ VM_ID │ VOL_ID │ Device   │
├───────┼───────────┼───────┼────────┼──────────┤
│ alice │ 10.0.0.42 │       │        │ device-x │
└───────┴───────────┴───────┴────────┴──────────┘
```

使用手动VM分配时，将忽略VM ID和数据卷ID字段。虚拟设备的所有管理，用户的持久数据量以及它们之间的绑定由操作员手动配置。

### 云平台实现自动化生命周期

为了大规模运行，SVMP监督器旨在使用云API协调虚拟设备的生命周期。在此模式下，用户连接和断开连接时，将动态创建和销毁用户的虚拟设备。

监督者依靠[pkgcloud](https://github.com/pkgcloud/pkgcloud)库来操纵各种云基础架构。目前，支持Openstack和Amazon AWS API。随着pkgcloud添加对其他云目标的支持，可以轻松扩展SVMP服务器以利用此功能。

要选择您的云平台，请`cloud_platform`在监督配置文件的选项中设置正确的值。在深入研究每个云平台的细节之前，下面是一些常见的配置选项。

**设置长度和寿命**

如果客户端连接并且还没有为其运行VM，则服务器将动态创建一个VM。当用户断开连接时，其VM将变为空闲状态。闲置太久后，VM将过期并被服务器破坏。以下配置选项控制此过程：

`vm_idle_ttl`：用户断开连接后允许VM存在的时间长度。如果用户在此计时器到期之前未重新连接，则VM将被销毁，并且下次我们看到此用户时必须创建一个新VM。

**设备类型和VM参数**

为了允许需要不同SVMP虚拟设备变体的用户，服务器维护从*设备类型*名称到存储在云中的虚拟设备基础映像的唯一ID的映射列表（例如，Amazon EC2 AMI ID或OpenStack Glance图像UUID）。

要正确配置SVMP服务器，您需要使用命令行工具的'images'命令从OpenStack获取一些信息。记下它返回的风味和图像ID。

```
$ svmp-config images

Image flavors available
┌─────────────────────────┬────┐
│ Name                    │ ID │
├─────────────────────────┼────┤
│ 512MB Standard Instance │ 1  │
├─────────────────────────┼────┤
│ svmp-flavor             │ 2  │
└─────────────────────────┴────┘

NOTE: Use the ID value when choosing a Flavor

Images available:
┌───────────────────┬──────────────────────────────────────┐
│ Name              │ ID                                   │
├───────────────────┼──────────────────────────────────────┤
│ phone-image       │ 7d532f18-88ed-489b-8b7a-9dfb72f0c8f4 │
├───────────────────┼──────────────────────────────────────┤
│ phablet-image     │ 63e6c5f0-e061-11e3-8df0-005056835866 │
├───────────────────┼──────────────────────────────────────┤
│ tablet-image      │ 4c33ef5c-6e78-47f9-bec3-243837c16469 │
└───────────────────┴──────────────────────────────────────┘
```

例如，部署可能会提供配置为提供不同UI体验的不同基本映像。这可以通过在配置文件`images`的`new_vm_defaults`部分下设置变量来实现。

```
new_vm_defaults:
    images:
        phone: "7d532f18-88ed-489b-8b7a-9dfb72f0c8f4"
        phablet: "63e6c5f0-e061-11e3-8df0-005056835866"
        tablet: "4c33ef5c-6e78-47f9-bec3-243837c16469"
    vmflavor: "2",
    ...
```

选择您选择的图像名称（“phone”，“phablet”，“tablet”），并设置以下值以匹配images命令输出中返回的图像ID。这些是使用配置工具`add`命令创建新用户帐户时将使用的设备类型名称。

设置`vmflavor`等于'images'命令返回的Image Flavor ID之一。这将选择要使用的VM资源模板（RAM，CPU等）。在此示例中，我们在OpenStack中定义了自定义模板“svmp-flavor”以供SVMP虚拟设备实例使用。

如果公共云迫使您选择一个预先存在的模板集，请使用至少具有1个CPU，1GB RAM和1GB根磁盘的模板。

**其他云设置**

根据所选云的网络架构，可能需要为VM分配浮动IP，以便外部网络可以访问它们。

如果是安装的情况，请设置`use_floating_ips`为true并设置`floating_ip_pool`为IP池以从中获取地址。如果不需要此功能，请保留`use_floating_ips`false，并且VM仅接收私有租户网络IP。

```
new_vm_defaults:
    ...
    use_floating_ips: true,
    floating_ip_pool: "nova",
    ...
```

最后一个变量`pollintervalforstartup`告诉svmp-server在尝试查询云API以确定VM存在之前，在订购要创建的VM之后应等待多长时间。不同的云安装将花费不同的时间来创建新实例。调整此值，直到它略大于云的典型新VM启动时间。

```
new_vm_defaults:
    ...
    pollintervalforstartup: 2000
    ...
```

**数据卷**

如果您希望使用SVMP服务器的命令行工具来创建用户的持久数据卷，请设置以下变量：

```c
new_vm_defaults:
    ...
    goldsnapshotId: "xxxx-xxxx-xxxx-xxxx"
    goldsnapshotSize: 6
    ...
```

如果使用OpenStack，`goldsnapshotId`则是克隆新创建的用户卷时要使用的主Cinder卷快照的UUID。该`goldsnapshotSize`应设置不小于GB的主卷的大小。如果使用AWS，`goldsnapshotId`则是从EBS卷创建的弹性块存储（EBS）快照的快照ID。**重要说明**：必须将其设置为*快照*，而不是正常卷，否则卷创建将失败。

正确设置这些变量后，命令行工具就可以创建用户卷，如下所示：

```
$ svmp-config volume-create <username>
```

这将创建从主卷克隆的新卷，并将其链接到该用户帐户。

或者，如果数据卷是以SVMP外部的其他方式创建的，则可以将它们手动分配给SVMP中的用户帐户。

```
$ svmp-config volume-assign <username> <volume-uuid>
```

#### 连接到OpenStack

要将SVMP监督程序与OpenStack连接，`openstack:`必须使用云提供程序的数据填写监督程序配置文件的部分，并且该`cloud_platform`选项必须设置为“openstack”。可以从云提供商或管理员或`openrc`通过OpenStack Horizon Web UI 获取的文件中获取适当的值。

#### 连接到Amazon Web Services

要将SVMP监督器与AWS连接，`aws:`必须使用AWS凭据的数据填写监督者配置文件的部分，并且该`cloud_platform`选项必须设置为“aws”。可以从[亚马逊](http://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSGettingStartedGuide/AWSCredentials.html)获得适当的值。

#### 测试您的云配置

配置云平台后，使用命令行客户端测试配置：

```
$ svmp-config images
```

如果正确配置了监督，将显示VM映像模板和flavor的表。如果未显示预期输出，请检查云配置值，然后重试。